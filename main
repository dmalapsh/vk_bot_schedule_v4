<?php
// ini_set('error_reporting', E_ALL);
// ini_set('display_errors', 'on');

$token = 'b67602f255d7b4ee1be0d0291ae66906f59b79a290edb36a8c63c0f8a92965de9a07fc673ade0b76435e6'; 
$confirmation_token = '754fbdb5'; 
$ids_admin			= 137038675;
$default_scrope 	= 2000; //—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ
$min_rate			=  100;	//–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞
$point_for_entry	=  100; //—Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å—Å—è –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ –≥—Ä—É–ø–ø—É
$point_for_repost	=   10; //–∑–∞ —Ä–µ–ø–æ—Å—Ç
$point_for_like 	=	 1; //–∑–∞ –ª–∞–π–∫







function create_photo($src){
    global $token;
		$request_params = array( 
        "peer_id" => 137038675,
		'access_token' => $token, 
		'v' => '5.9'); 
		
		$get_params = http_build_query($request_params); 
		$response = json_decode(file_get_contents('https://api.vk.com/method/photos.getMessagesUploadServer?'.$get_params))->response; 
        $url = $response->upload_url;
$curl_file = curl_file_create(__DIR__ . '/'.$src, 'mimetype' , 'image.jpeg');
 
$ch = curl_init($url);  
curl_setopt($ch, CURLOPT_POST, 1);  
curl_setopt($ch, CURLOPT_POSTFIELDS, array('photo' => $curl_file));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_HEADER, false);
$res = json_decode(curl_exec($ch));
curl_close($ch);	
$request_params = array( 
        "photo" => $res->photo,
        "server" =>$res->server,
        "hash" =>$res->hash,
		'access_token' => $token, 
		'v' => '5.9'); 
		
		$get_params = http_build_query($request_params); 
$photo = json_decode(file_get_contents('https://api.vk.com/method/photos.saveMessagesPhoto?'.$get_params))->response[0];
return $photo;
}



	//echo $file_age = (int)((time() - filemtime('current_source.txt'))/60);


	
	
//   file_put_contents('current_source.txt'," hi,and this is ok");

		if (!isset($_REQUEST)) { 
	return; 
	} 

// 	–ü–æ–ª—É—á–∞–µ–º –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ 
	$data = json_decode(file_get_contents('php://input')); 
	//send_mass('–æ–ª—Ä',137038675);	

	switch ($data->type) { 
	case 'confirmation': 
		echo $confirmation_token; 
	break; 
	//–ï—Å–ª–∏ —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏... 
	case 'message_new': processing_mess();
	break; }
	
	
	
	
	
	
	
	
	function processing_mess(){
		global $data,$min_rate;
		$user_id = $data->object->peer_id; 
		switch($data->object->text){
		    case "1":case "üè¢ 1 –∫–æ—Ä–ø—É—Å": case "üè¢ –ö–æ—Ä–ø—É—Å 1":
		        $photo = create_photo("spo.jpg");
                $att = array("photo".$photo->owner_id."_".$photo->id."_".$photo->access_key);
                send_mass("",$user_id,$att);
		    break;
		    case "2":case "üè¢ 2 –∫–æ—Ä–ø—É—Å":
		        $photo = create_photo("npo.jpg");
                $att = array("photo".$photo->owner_id."_".$photo->id."_".$photo->access_key);
               send_mass("",$user_id,$att);
            break;
			case "—Å—á–µ—Ç" :
				$out = "–ù–∞ –≤–∞—à–µ–º —Å—á–µ—Ç–µ ".bd_serch($user_id);
				send_mass($out,$user_id);
			break;
			case "–ù–∞—á–∞—Ç—å": case "–°–ø—Ä–∞–≤–∫–∞": case "—Å–ø—Ä–∞–≤–∫–∞": case"?":
				send_mass("–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –Ω–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∫–æ—Ä–ø—É—Å–∞. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É. –¢–∞–∫–∂–µ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç–æ–º—É —á—Ç–æ —ç—Ç–æ—Ç –±–æ—Ç –±—ã–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ, —É –Ω–µ–≥–æ –æ—Å—Ç–∞–ª—Å—è –∏–≥—Ä–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª. –í–∞—à —Å—á–µ—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑ –¥–µ–π—Å—Ç–≤–∏–π: –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å—á–µ—Ç –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É.<br>–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞, –Ω–∞ –Ω–µ–º –±—É–¥–µ—Ç —Å—Ä–∞–∑—É –∂–µ –ª–µ–∂–∞—Ç—å 2000 –±–∞–ª–ª–æ–≤.
					–ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á–µ—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–æ–≤–æ —Å—á–µ—Ç
					–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–∏–º–≤–æ–ª * –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏(–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è - 100 –±–∞–ª–ª–æ–≤), –Ω–∞–ø—Ä–∏–º–µ—Ä: *2000",$user_id);
			break;
			case "–ø–µ—Ä–µ":
				$attach = $data->object->attachments;
				$out_att = array();

				foreach ($attach as $value) {
				 	$type = $value->type;
				 	$id = $value->$type->id;
				 	$owner_id = $value->$type->owner_id;
				 	$str_push = $type.$owner_id."_".$id;
				 	array_push($out_att,$str_push);
					}
				 
				send_mass("",$user_id,$out_att);
			break;
			default:
				if($data->object->text{0} == "*"){				//–µ—Å–ª–∏ –ø–µ—Ä–≤–π —Å–∏–º–≤–æ–ª *
					$rest = substr($data->object->text, 1);
					$ball = bd_serch($user_id);
					if ($rest<=$ball){
						if ($rest>=$min_rate){
						switch (rand(1, 4)){
							case 1:
								$ball = $ball + $rest;
								bd_edit($user_id,$ball);
								send_mass("—É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –Ω–∞ {$rest}, —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å {$ball}",$user_id);
							break;
							case 2:
								$rest = $rest/2;
								$ball = $ball + $rest;
								bd_edit($user_id,$ball);
								send_mass("—É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –Ω–∞ {$rest} —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å {$ball}",$user_id);
							break;
							case 3:
								$rest = $rest/2;
								$ball = $ball - $rest;
								bd_edit($user_id,$ball);
								send_mass("—É–º–µ–Ω—å—à–∏–ª–æ—Å—å –Ω–∞ {$rest} —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å {$ball}",$user_id);
							break;
							case 4: 
								$ball = $ball - $rest;
								bd_edit($user_id,$ball);
								send_mass("—É–º–µ–Ω—å—à–∏–ª–æ—Å—å –Ω–∞ {$rest} —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å {$ball}",$user_id);
							break;
								};
							}else{
								send_mass("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ {$min_rate}",$user_id);
							};
						
						}else{
						send_mass("–£ –≤–∞—Å –ª–∏—à—å {$ball}",$user_id);}
				}
				else{
					
				 $attach = $data->object->attachments;
				 $text =$data->object->text;
				 $out_att = array();

				foreach ($attach as $value) {
				 	$type = $value->type;
				 	$id = $value->$type->id;
				 	$owner_id = $value->$type->owner_id;
				 	$str_push = $type.$owner_id."_".$id;
				 	array_push($out_att,$str_push);
					}
				 
				send_mass($text,$user_id,$out_att);
					
				};
		 }
		 
	}
 	
echo('ok');
	//send_mass("",137038675,array("photo445654414_456239253"));
function send_mass($text, $user_id, $attach = ""){

	    $keyboard = '{"buttons":[
	        [{"action":{"type":"text","label":"üè¢ 1 –∫–æ—Ä–ø—É—Å"},"color":"negative"},{"action":{"type":"text","label":"üè¢ 2 –∫–æ—Ä–ø—É—Å"},"color":"negative"}]
	        ],"one_time":false}';
		if	($attach == "") unset($attach);
		if ($text == ""){
			unset($text);}
			$attach = implode(',', $attach);;
		
	global $token;
 		$request_params = array( 
		'message' => $text, 
		'user_ids' => $user_id, 
		'attachment'  => $attach,
		'keyboard' =>$keyboard,
		'access_token' => $token, 
		'v' => '5.9'); 
		
		$get_params = http_build_query($request_params); 
		file_get_contents('https://api.vk.com/method/messages.send?'. $get_params); 
 	};
	
function bd_serch($user_id){	
	$link = new mysqli('localhost', "cm56270_like", '10119alina', 'cm56270_like');
	if ( !$link ) die("–æ—à–∏–±–∫–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö");
	$link ->query("SET NAMES 'utf8' ");
	$query = 'SELECT * FROM `–æ—á–∫–∏` WHERE `id`IN ('.$user_id.')';//;SELECT * FROM users WHERE age IN (21,26,33)
	$bd_user_ids = mysqli_query($link,$query);
		
	if($varible = mysqli_fetch_row($bd_user_ids)){		//—É—Å–ª–æ–≤–∏–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è id –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
		return	$varible[1];
		}else{
			global $default_scrope;
			$link ->query("INSERT INTO –æ—á–∫–∏ (id, point) VALUE ('".$user_id."', '".$default_scrope."')");
			return $default_scrope;
		};
	mysqli_close($link);

}
	function bd_edit($user_id,$value){
		$link = new mysqli('localhost', "cm56270_like", '10119alina', 'cm56270_like');
		$link ->query("UPDATE `–æ—á–∫–∏` SET point ='{$value}' WHERE `id`= '".$user_id."'");
	}
		
		
		
		
		
		
		
		
		
		
